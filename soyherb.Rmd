---
title: "Soybean herbicide study - Dan Smith"
author: "Maxwel Coura Oliveira"
date: "10/28/2020"
output: 
  html_document:
    toc: yes
    theme: yeti
    number_sections: yes
    toc_depth: 4
    highlight: espresso
---

# Load packages 

```{r echo=TRUE, message=FALSE, warning=FALSE}
library(tidyverse)
library(emmeans)
library(glmmTMB)
library(kableExtra)
library(lme4)
library(lmerTest)
```

# Load dataset

```{r echo=TRUE, message=FALSE, warning=FALSE}
data <- read_csv("SB12.csv")
```

## Glimpse dataset

```{r echo=TRUE, message=FALSE, warning=FALSE}
glimpse(data)
```

## Skim dataset

```{r echo=TRUE, message=FALSE, warning=FALSE}
skimr::skim(data)
```

```{r}
view(data)
```


# Data visualization

## Waterhemp control at 14 DAT

```{r fig.align='center'}
ggplot(data, aes(x = reorder(other,waterhempcontrol_14), 
                 y = waterhempcontrol_14,
       fill=trade, color=trade)) +
  geom_boxplot(color="black") +
  geom_jitter(alpha=0.2) +
  facet_grid(year ~ location) +
  coord_flip() +
  ylim(0, 100) +
  labs(x="", y="Waterhemp control (%)") +
  theme_minimal() +
  theme(legend.position = "none")
```


## Waterhemp control at 28 DAT

```{r fig.align='center'}
ggplot(data, aes(x=reorder(other,waterhempcontrol_28), y=waterhempcontrol_28,
       fill=trade, color=trade)) +
  geom_boxplot(color="black") +
  geom_jitter(alpha=0.2) +
  facet_grid(year ~ location) +
  coord_flip() +
  ylim(0, 100) +
  labs(x="", y="Waterhemp control (%)") +
  theme_minimal() +
  theme(legend.position = "none")
```




## Waterhemp control at harvest

```{r fig.align='center', message=FALSE, warning=FALSE}
ggplot(data, aes(x=reorder(other,waterhempcontrol_harvest), y=waterhempcontrol_harvest,
       fill=trade, color=trade)) +
  geom_boxplot(color="black") +
  geom_jitter(alpha=0.2) +
  facet_grid(year ~ location) +
  coord_flip() +
  ylim(0, 100) +
  labs(x="", y="Waterhemp control (%)") +
  theme_minimal() +
  theme(legend.position = "none")
```


## Weed biomass

```{r fig.align='center', message=FALSE, warning=FALSE}
ggplot(data, aes(x=reorder(other,biomass_gm2), y=biomass_gm2,
       fill=trade, color=trade)) +
  geom_boxplot(color="black") +
  geom_jitter(alpha=0.2) +
  facet_grid(year ~ location) +
  coord_flip() +
  ylim(0, 100) +
  labs(x="", y="Weed biomass (g m2)") +
  theme_minimal() +
  theme(legend.position = "none")
```




## Yield (bu/acre)

```{r message=FALSE, warning=FALSE, fig.align='center'}
ggplot(data, aes(x=reorder(other,yield_bu), y=yield_bu,
       fill=trade, color=trade)) +
  geom_boxplot(color="black") +
  geom_jitter(alpha=0.2) +
  facet_grid(year ~ location) +
  coord_flip() +
  labs(x="", y="Waterhemp control (%)") +
  theme_minimal() +
  theme(legend.position = "none")
```
# Data wrangling

```{r}
new_dt <- 
  data %>% 
  rename (herbicide = other) %>% 
  mutate(
    wt_14 = waterhempcontrol_14/100,
    wt_28 = waterhempcontrol_28/100,
    yield_kg = yield_bu * 67.5) %>% 
  mutate(
    wt_14 = 
      case_when(
        waterhempcontrol_14 == 100   ~  0.99,
        TRUE            ~ wt_14),
    wt_28 = case_when(
        waterhempcontrol_28 == 100   ~  0.99,
        waterhempcontrol_28 == 0   ~  0.01,
        TRUE            ~ wt_28)) %>% 
  filter(
    herbicide != "PRE only"
  )
```


# Data analysis

## Waterhemp control at 14 DAT

### Model

* Model using herbicide trts, year, and location as fixed effects. Only rep as random effects

```{r message=FALSE, warning=FALSE}
model_14 <- glmmTMB(wt_14 ~ herbicide * location * year + 
                      (1|rep), 
                    beta_family(link = "logit"), data=new_dt)
```

### Anova

```{r message=FALSE, warning=FALSE}
glmmTMB:::Anova.glmmTMB(model_14)
```

* Anova shows no interaction of year, herbicide and location. There is only herbicide and year effects


### New model

Model using herbicide trt as fixed, and rep, year, and location as random effects

```{r message=FALSE, warning=FALSE}
model_14_2 <- glmmTMB(wt_14 ~ herbicide + (1|rep) + 
                        (1|location/year), beta_family(link = "logit"), 
                      data=new_dt)
```

### New Anova

```{r message=FALSE, warning=FALSE}
glmmTMB:::Anova.glmmTMB(model_14_2)
```

- No effects of herbicide treatments. However, I am looking into herbicide effects.

### Least square means

```{r }
lsmeans_14 <- emmeans(model_14_2, ~ herbicide, cont="pairwise", 
                      adjust="none", type="response", alpha=0.05)
```


### Compact letter display

```{r fig.align='center'}
plot(lsmeans_14, ~ herbicide, comparisons=TRUE, type="response", 
     alpha=0.05, adjust="none") + xlim(0, 1)
```


```{r message=FALSE, warning =FALSE}
multcomp::cld(lsmeans_14$emmeans, alpha=0.05, Letters=letters, 
    adjust="none", 
    reversed = TRUE) %>%
  kbl() %>%
  kable_classic_2(full_width = F)
```




## Waterhemp control at 28 DAT

### Model

* Model using herbicide trts, year, and location as fixed effects. Only rep as random effects

```{r message=FALSE, warning=FALSE}
model_28 <- glmmTMB(wt_28 ~ herbicide * location * year + (1|rep), 
                    beta_family(link = "logit"), data=new_dt)
```

### Anova

```{r message=FALSE, warning=FALSE}
glmmTMB:::Anova.glmmTMB(model_28)
```



* Anova shows no interaction of year, herbicide and location. There is only herbicide and year effects


### New model

Model using herbicide trt as fixed, and rep, year, and location as random effects

```{r message=FALSE, warning=FALSE}
model_28_2 <- glmmTMB(wt_28 ~ herbicide + (1|rep) + (1|location/year),
                      beta_family(link = "logit"), data=new_dt)
```

### New Anova

```{r message=FALSE, warning=FALSE}
glmmTMB:::Anova.glmmTMB(model_28_2)
```

- No effects of herbicide treatments

### Least square means

```{r }
lsmeans_28 <- emmeans(model_28_2, ~ herbicide, cont="pairwise", 
                      adjust="none", type="response", alpha=0.05)
```

### Plot

```{r fig.align='center'}
plot(lsmeans_28, ~ herbicide, comparisons=TRUE, type="response", 
     alpha=0.05, adjust="none") + xlim(0,1)
```

### Compact letter display

```{r message=FALSE, warning =FALSE}
multcomp::cld(lsmeans_28$emmeans, alpha=0.05, Letters=letters, 
    adjust="none", reversed = TRUE) %>%
  kbl() %>%
  kable_classic_2(full_width = F)
```


```{r include=FALSE}
if(requireNamespace("multcomp")) {
    multcomp::cld(lsmeans_28$emmeans, alpha=0.05, Letters=letters, adjust="none", reversed = TRUE)
}
```



```{r}
nd14 <- data.frame(lsmeans_14$emmeans) %>% 
  mutate(dat = "14 DAT")
nd28 <- data.frame(lsmeans_28$emmeans)  %>% 
  mutate(dat = "28 DAT")
nd <- bind_rows(nd14, nd28)


nd %>% 
  mutate(herbicide = fct_relevel(herbicide, c("PRE fb glufosinate",
                    "PRE fb glufosinate + acetochlor",
                    "PRE fb glufosinate + dimethenamid-P",
                    "PRE fb glufosinate + S-metolachlor",
                    "PRE fb glufosinate + imazethapyr",
                    "PRE fb glufosinate + fomesafen",
                    "PRE fb glufosinate + pyroxasulfone",
                    "PRE fb glufosinate + fomesafen + acetochlor",
                    "PRE fb glufosinate + fomesafen + S-metolachlor"))) %>%
ggplot(aes(x=herbicide, response, y=response*100)) + 
  facet_wrap(~dat) +
  coord_flip() + 
  geom_point(size=3, color="#282728") + 
  theme_bw() +  
  labs(y="Waterhemp control (%)", x="", title="") +
  geom_errorbar(aes(ymin  =  lower.CL*100, ymax  =  upper.CL*100), width =  0.3, size  =  1, color="#282728") + 
  theme(axis.title = element_text(size=20, color="#282728", face="bold"), 
        axis.text.x = element_text(size=18, angle=0, hjust=1,
                                   color="#282728"), 
        axis.text.y = element_text(size=18, color="#282728"),
        plot.title = element_text(size=30, face="bold", hjust = 1, 
                                    color="#c5050c"), 
        strip.text = element_text(size=25, face="bold", color="#282728"),          strip.background =element_rect(fill="#dadfe1")) + 
  geom_hline(yintercept=90, linetype="dashed", color="#c5050c", size=1.2, show.legend = TRUE) +
  ylim(0,100) 

ggsave("figures/Figure2.png", width=18, height=9, dpi=600)
```



## Yield 


### Yield raw data distribution

```{r warning=FALSE, message=FALSE}
library(ggridges)
new_dt %>% 
  ggplot(
    aes(y=herbicide, x=yield_kg, fill=herbicide)) +
      geom_density_ridges(scale=2, show.legend = FALSE)
```

### Data manipulation

```{r warning=FALSE, message=FALSE}
yield_dt <- new_dt %>% 
  mutate(
    siteyr = case_when(
      location == "Lancaster" & year == 2020 ~ "Lan20",
      location == "Lancaster" & year == 2019 ~ "Lan19",
      location == "Brooklyn" & year == 2020 ~ "Bro20",
      location == "Brooklyn" & year == 2019 ~ "Bro19",
      TRUE                     ~  "siteyr"
    )
  )
```

### Model

```{r warning=FALSE}
fit <- lmer(yield_kg ~ herbicide * siteyr + (1|rep), data=yield_dt)
```

### Anova

```{r}
anova(fit)
```

### Least square means


```{r }
lsmeans_fit <- emmeans(fit, ~ siteyr, cont="pairwise", adjust="none", alpha=0.05)
```

### Plot

```{r fig.align='center'}
plot(lsmeans_fit, ~ siteyr, comparisons=TRUE, type="response", 
     alpha=0.05, adjust="none")
```

### Compact letter display

```{r message=FALSE, warning =FALSE}
multcomp::cld(lsmeans_fit$emmeans, alpha=0.05, Letters=letters, adjust="none", reversed = TRUE) %>%
  kbl() %>%
  kable_classic_2(full_width = F)
```


<br><br>

```{r echo=FALSE, out.width=400, fig.align='center'}
knitr::include_graphics("https://media.giphy.com/media/l0Iyl55kTeh71nTXy/giphy.gif")
```
